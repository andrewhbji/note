# 第一章 设备驱动简介

[TOC]
## 驱动程序的角色
## 划分内核
## 设备和模块的分类
## 安全问题
## 版权条款

## 驱动程序的角色
驱动程序的角色是提供什么能力(即提供机制)，至于如何使用这些能力(即提供策略)，则是用户空间的程序所关注的.

驱动程序是应用程序和硬件之间的软件层.

驱动程序设计应当是在许多不同考虑中的平衡，比如如何处理并发，实现存储映射而不直接依赖硬件的IO能力，或是提供一个用户库帮助应用开发者在可用的原语之上实现新策略等等. 一个主要的考虑是在展现给用户尽可能多的选项, 和你不得不花费的编写驱动的时间之间做出平衡, 还有需要保持事情简单以避免潜在的错误.

对策略透明的驱动，具有支持同步和异步操作，可重入，能利用硬件的全部能力，没有软件层来“简化事情”或提供和策略相关的操作.


## 划分内核

### Linux内核的划分
- 进程管理:  负责创建和销毁进程，处理输入和输出，提供进程件通信的能力，提供进程调度能力，提供多处理器运行能力.
- 内存管理: 内核为所有进程的每一个都在有限的可用资源上建立了一个虚拟地址空间. 内核的不同部分与内存管理子系统通过一套函数调用交互, 从简单的 malloc/free 对到更多更复杂的功能.
- 文件系统: Unix 在很大程度上基于文件系统的概念; 几乎 Unix 中的任何东西都可看作一个文件. 内核在非结构化的硬件之上建立了一个结构化的文件系统, 结果是文件的抽象非常多地在整个系统中应用. 另外, Linux 支持多个文件系统类型, 就是说, 物理介质上不同的数据组织方式. 例如, 磁盘可被格式化成标准 Linux 的 ext3 文件系统, 普遍使用的 FAT 文件系统, 或者其他几个文件系统. 
- 设备控制: 几乎每个系统操作最终都映射到一个物理设备上. 除了处理器, 内存和非常少的别的实体之外, 全部中的任何设备控制操作都由特定于要寻址的设备相关的代码来进行. 这些代码称为设备驱动. 内核中必须嵌入系统中出现的每个外设的驱动, 从硬盘驱动到键盘和磁带驱动器. 内核功能的这个方面是本书中的我们主要感兴趣的地方.
- 网络: 网络必须由操作系统来管理, 因为大部分网络操作不是特定于某一个进程: 进入系统的报文是异步事件. 报文在某一个进程接手之前必须被收集, 识别, 分发. 系统负责在程序和网络接口之间递送数据报文, 它必须根据程序的网络活动来控制程序的执行. 另外, 所有的路由和地址解析问题都在内核中实现.

## 设备和模块的分类
- 字符设备: 通常至少要实现open、close、read、write系统调用。
- 块设备: 要能够容纳文件系统。
- 网络接口: 网络设备确是面向数据包的，内核调用一套和数据包传输相关的函数而不是read和write

## 安全问题
- 谨防内存溢出
- 对于数据：
1.任何用户空间传入的数据必须经过验证;
2.内核传出的地址使用前必须清零或初始化;
3.只有特权用户才允许一些危险操作。

## 版权条款
只要使用 Linux 内核函数的代码都要遵守GPL协议，即二进制文件的获得者有权利要求供应商开源。
>备注：使用推送方式升级内核(即用户不能获取二进制文件)，供应商没有必要开放升级的代码